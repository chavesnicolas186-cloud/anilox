

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Anilox</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #2463EB; --secondary: #fd7e14; --success: #20c997; --danger: #e84a5f; --warning: #ffc107;
            --bg-light: #f4f6f9; --bg-card: #ffffff; --text-dark: #333333; --text-light: #6c757d; --text-white: #ffffff;
            --border: #dee2e6; --card-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            --font-primary: 'Poppins', sans-serif; --font-mono: 'JetBrains Mono', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body {
            font-family: var(--font-primary); line-height: 1.6; color: var(--text-dark);
            background-color: var(--bg-light); padding: 20px;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        .main-container {
            max-width: 1600px; margin: 10px auto; background-color: var(--bg-card);
            padding: 30px 40px; border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--card-shadow);
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; flex-wrap: wrap; gap: 20px;
        }
        h1 {
            font-weight: 700; color: var(--primary); font-size: 1.8rem;
            display: flex; align-items: center; gap: 15px;
        }
        h2 {
            margin-bottom: 20px; font-size: 1.3rem; border-bottom: 3px solid var(--secondary);
            padding-bottom: 8px; font-weight: 600; color: var(--primary);
        }
        .nav-tabs {
            display: flex; margin-bottom: 30px; gap: 8px; border-bottom: 1px solid var(--border);
        }
        .nav-tab {
            padding: 10px 20px; cursor: pointer; background-color: transparent;
            border: 1px solid transparent; border-bottom: 3px solid transparent;
            border-radius: 6px 6px 0 0; font-weight: 500; font-size: 0.9rem;
            color: var(--text-light); transition: all 0.2s ease-in-out; margin-bottom: -1px;
        }
        .nav-tab:hover { background-color: var(--bg-light); color: var(--primary); }
        .nav-tab.active {
            border-color: var(--border) var(--border) var(--bg-card) var(--border);
            border-bottom-color: var(--primary); color: var(--primary); font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .controls-section {
            display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px;
            padding: 25px; border: 1px solid var(--border); border-radius: 8px; background-color: var(--bg-light);
        }
        .controls-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; align-items: flex-end;
        }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        label {
            font-family: var(--font-mono); font-weight: 500; font-size: 0.8rem;
            color: var(--text-light); text-transform: uppercase;
        }
        input[type="text"], input[type="number"], input[type="date"], textarea, select {
            padding: 12px 15px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.95rem; font-family: var(--font-mono); background-color: #fff;
            color: var(--text-dark); width: 100%; transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(36, 99, 235, 0.2); }
        
        button {
            background-color: var(--primary); color: var(--text-white); border: none;
            padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            font-weight: 600; font-family: var(--font-primary); text-transform: uppercase;
            letter-spacing: 0.8px; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:hover:not(:disabled) { background-color: var(--secondary); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transform: translateY(-2px); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-danger { background-color: var(--danger); }
        .btn-danger:hover:not(:disabled) { background-color: #c2303f; }
        .btn-small { padding: 6px 12px; font-size: 0.75rem; margin: 0; width: 100%; }
        .spinner {
            width: 18px; height: 18px; border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .table-container {
            overflow-x: auto; border: 1px solid var(--border); border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-top: 20px; max-height: 70vh;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td {
            padding: 12px 15px; text-align: center; font-family: var(--font-mono);
            vertical-align: middle; border-bottom: 1px solid var(--border);
        }
        th {
            background-color: var(--bg-light); color: var(--text-dark); font-weight: 600;
            font-family: var(--font-primary); text-transform: uppercase; letter-spacing: 0.5px;
            font-size: 0.75rem; position: sticky; top: 0; z-index: 1; cursor: pointer;
        }
        th .sort-indicator { display: inline-block; margin-left: 8px; opacity: 0.7; width: 1em; }
        .estado-cell {
            max-width: 350px; white-space: pre-wrap; text-align: left; font-size: 0.8rem;
            line-height: 1.5;
        }
        .estado-cell strong { color: var(--primary); }

        .status-badge {
            padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;
            font-weight: 600; color: var(--text-white); font-family: var(--font-primary);
            text-transform: uppercase;
        }
        .status-badge.status-ok { background-color: var(--success); }
        .status-badge.status-atencao { background-color: var(--warning); color: var(--text-dark); }
        .status-badge.status-critico { background-color: var(--danger); }
        .status-badge.status-na { background-color: var(--text-light); }

        .modal-overlay {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: var(--bg-card); padding: 30px 40px; border: 1px solid var(--border);
            border-radius: 12px; box-shadow: var(--card-shadow); width: 90%; max-width: 700px; position: relative;
        }
        .modal-content.modal-xl { max-width: 90vw; }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border);
        }
        .modal-header h2 { margin: 0; border: none; padding: 0; font-size: 1.3rem; }
        .close-button { color: var(--text-light); font-size: 2rem; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-button:hover { color: var(--danger); }
        #chart-container { position: relative; height: 60vh; width: 100%; }
        .placeholder { color: var(--text-light); text-align: center; padding: 40px; font-style: italic; }

        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            padding: 15px 20px; border-radius: 8px; color: var(--text-white);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500;
            opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards; min-width: 250px;
        }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOut { to { opacity: 0; transform: translateX(100%); } }

        #dashboard-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;
        }
        .kpi-card {
            background-color: var(--bg-light); padding: 25px; border-radius: 8px;
            border-left: 5px solid var(--primary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1); }
        .kpi-card .value { font-size: 2.5rem; font-weight: 700; color: var(--text-dark); }
        .kpi-card .label { font-size: 1rem; font-weight: 500; color: var(--text-light); }
        
        .performance-card {
            background-color: #fff; padding: 25px; border-radius: 8px;
            border: 1px solid var(--border); grid-column: 1 / -1; margin-top: 15px;
        }
        .weekly-progress-container {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 15px;
            text-align: center; margin-top: 10px;
        }
        .day-progress-item {
            background-color: var(--bg-light); padding: 15px; border-radius: 8px;
        }
        .day-label {
            font-weight: 600; color: var(--text-dark); font-size: 0.9rem; text-transform: capitalize;
        }
        .day-progress {
            font-weight: 700; font-size: 1.5rem; margin-top: 8px; font-family: var(--font-mono);
        }
        .day-progress.goal-met { color: var(--success); }
        .day-progress.goal-not-met { color: var(--secondary); }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="main-container">
        <div class="header">
            <h1><img src="https://github.com/chavesnicolas186-cloud/anilox/blob/main/anilox.webp?raw=true" alt="Logo" height="40"> Gestão de Anilox</h1>
            <button onclick="openModal('addAniloxModal')">+ Adicionar Novo Anilox</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab(event,'dashboardTab')">Dashboard</button>
            <button class="nav-tab" onclick="showTab(event,'aniloxTab')">Anilox</button>
            <button class="nav-tab" onclick="showTab(event,'reportTab')">Relatório de Performance</button>
            <button class="nav-tab" onclick="showTab(event,'settingsTab')">Configurações</button>
        </div>

        <div id="dashboardTab" class="tab-content active">
            <h2>Dashboard Estratégico</h2>
            <div id="dashboard-grid"></div>
        </div>

        <div id="aniloxTab" class="tab-content">
            <h2>Lista de Anilox</h2>
            <div class="controls-section" style="padding: 15px; margin-bottom: 15px; background-color: #fff;">
                <div class="input-group">
                    <label for="searchInput">Pesquisar Anilox (por Nº)</label>
                    <input type="text" id="searchInput" placeholder="Digite o número do anilox para filtrar...">
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th onclick="render.sortTable('id')">Nº<span class="sort-indicator"></span></th>
                            <th onclick="render.sortTable('bcm_original')">BCM Original<span class="sort-indicator"></span></th>
                            <th onclick="render.sortTable('bcm_atual')">BCM Atual<span class="sort-indicator"></span></th>
                            <th onclick="render.sortTable('vida_util')">% Vida Útil<span class="sort-indicator"></span></th>
                            <th onclick="render.sortTable('lineatura')">Lineatura<span class="sort-indicator"></span></th>
                            <th style="width: 30%;">Estado Detalhado</th>
                            <th onclick="render.sortTable('ultima_atividade')">Últ. Atividade<span class="sort-indicator"></span></th>
                            <th>Status Volume</th>
                            <th>Status Limpeza</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="aniloxTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="reportTab" class="tab-content">
            <h2>Relatório de Performance por Período</h2>
            <div class="controls-section">
                <div class="controls-grid">
                    <div class="input-group">
                        <label for="startDate">Data de Início</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="input-group">
                        <label for="endDate">Data de Fim</label>
                        <input type="date" id="endDate">
                    </div>
                    <button onclick="generateComprehensiveReport()">Gerar Análise</button>
                </div>
            </div>
            <div id="reportResults">
                <p class="placeholder">Selecione um período para ver a performance detalhada.</p>
            </div>
        </div>

        <div id="settingsTab" class="tab-content">
            <h2>Configurações de Alerta</h2>
            <div class="controls-section">
                <div class="controls-grid">
                    <div class="input-group"><label for="attentionThreshold">% BCM para Atenção:</label><input type="number" id="attentionThreshold" required></div>
                    <div class="input-group"><label for="criticalThreshold">% BCM para Crítico:</label><input type="number" id="criticalThreshold" required></div>
                    <div class="input-group"><label for="washAttentionDays">Dias p/ Limpeza Atenção:</label><input type="number" id="washAttentionDays" required></div>
                    <div class="input-group"><label for="washCriticalDays">Dias p/ Limpeza Crítica:</label><input type="number" id="washCriticalDays" required></div>
                </div>
            </div>
            <button id="saveSettingsBtn">Salvar Configurações</button>
            <h2 style="margin-top: 40px;">Gerenciamento de Dados</h2>
            <div class="controls-section">
                 <button id="resetData" class="btn-danger">Resetar Todos os Dados</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addMeasurementModal" class="modal-overlay"></div>
    <div id="addAniloxModal" class="modal-overlay"></div>
    <div id="chartModal" class="modal-overlay"></div>
    <div id="addWashModal" class="modal-overlay"></div>
    <div id="editAniloxModal" class="modal-overlay"></div>

    <script>
        const SUPABASE_URL = 'https://qonapwpnnknvnhvjysjc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvbmFwd3Bubmtudm5odmp5c2pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NDUwMTIsImV4cCI6MjA3NDEyMTAxMn0.DqkQuENorS1cH4mTyyGvWdohfS5ac4AyO3nufrbBf5E';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let aniloxData = [];
        let settings = {};
        const charts = {};
        let currentSort = { column: 'id', direction: 'asc' };

        const defaultSettings = { attention: 90, critical: 80, washAttention: 3, washCritical: 7 };

        const db = {
            fetchAniloxData: async () => (await supabaseClient.from('anilox').select('*')).data || [],
            updateAniloxRecord: async (id, data) => (await supabaseClient.from('anilox').update(data).eq('id', id).select()).data,
            addAniloxRecord: async (anilox) => (await supabaseClient.from('anilox').insert(anilox).select()).data,
            fetchSettings: async () => ((await supabaseClient.from('settings').select('config').eq('id', 1).single()).data?.config) || defaultSettings,
            saveSettings: async (config) => await supabaseClient.from('settings').upsert({ id: 1, config }),
            resetAllData: async () => {
                await supabaseClient.from('anilox').delete().neq('id', 'dummy');
                await supabaseClient.from('settings').delete().eq('id', 1);
            }
        };
        
        const ui = {
            showTab: (evt, tabId) => {
                document.querySelectorAll('.tab-content, .nav-tab').forEach(el => el.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                evt.currentTarget.classList.add('active');
            },
            openModal: (modalId) => document.getElementById(modalId).style.display = 'flex',
            closeModal: (modalId) => document.getElementById(modalId).style.display = 'none',
            showToast: (message, type = 'success') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.5s forwards';
                    toast.addEventListener('animationend', () => toast.remove());
                }, 3000);
            },
            handleFormSubmit: async (button, action) => {
                const originalContent = button.innerHTML;
                button.innerHTML = `<div class="spinner"></div>`;
                button.disabled = true;
                try {
                    await action();
                } catch (error) {
                    console.error("Erro na operação:", error);
                    ui.showToast(error.message || 'Ocorreu um erro.', 'error');
                } finally {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }
            }
        };

        const render = {
            all: () => {
                render.dashboard();
                render.table();
            },
            populateSettingsForm: (s) => {
                document.getElementById('attentionThreshold').value = s.attention;
                document.getElementById('criticalThreshold').value = s.critical;
                document.getElementById('washAttentionDays').value = s.washAttention;
                document.getElementById('washCriticalDays').value = s.washCritical;
            },
            sortTable: (column) => {
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }
                render.table();
            },
            dashboard: () => {
                const grid = document.getElementById('dashboard-grid');
                if (!aniloxData || aniloxData.length === 0) {
                    grid.innerHTML = `<p class="placeholder" style="grid-column: 1 / -1;">Sem dados para exibir.</p>`;
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dailyWashGoal = 8;
                
                let criticalVolumeCount = 0;
                let criticalCleaningCount = 0;
                let totalLife = 0;
                let measuredCount = 0;
                
                const weeklyWashCounts = new Map();
                const dayLabels = [];

                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(today.getDate() - i);
                    const dateString = date.toISOString().slice(0, 10);
                    weeklyWashCounts.set(dateString, 0);
                    
                    let label;
                    if (i === 0) label = 'Hoje';
                    else if (i === 1) label = 'Ontem';
                    else label = date.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '');
                    dayLabels.push({ dateString, label });
                }

                aniloxData.forEach(a => {
                    const latestMeasurement = a.historico.length > 0 ? a.historico.slice().sort((d1, d2) => new Date(d2.data) - new Date(d1.data))[0] : null;
                    if (latestMeasurement) {
                        const life = (latestMeasurement.bcmAtual / a.bcm_original) * 100;
                        totalLife += life;
                        measuredCount++;
                        if (life < settings.critical) criticalVolumeCount++;
                    }

                    const latestWash = a.lavagens.length > 0 ? a.lavagens.sort().reverse()[0] : null;
                    if (latestWash) {
                        const lastWashDate = new Date(latestWash + 'T12:00:00Z');
                        if (Math.floor((today - lastWashDate) / 86400000) >= settings.washCritical) {
                            criticalCleaningCount++;
                        }
                    }
                    
                    a.lavagens.forEach(washDate => {
                        if (weeklyWashCounts.has(washDate)) {
                            weeklyWashCounts.set(washDate, weeklyWashCounts.get(washDate) + 1);
                        }
                    });
                });

                const avgLife = measuredCount > 0 ? (totalLife / measuredCount).toFixed(1) : 'N/A';
                
                let weeklyProgressHTML = '';
                dayLabels.forEach(({ dateString, label }) => {
                    const count = weeklyWashCounts.get(dateString) || 0;
                    const goalMetClass = count >= dailyWashGoal ? 'goal-met' : 'goal-not-met';
                    weeklyProgressHTML += `
                        <div class="day-progress-item">
                            <div class="day-label">${label}</div>
                            <div class="day-progress ${goalMetClass}">${count} / ${dailyWashGoal}</div>
                        </div>
                    `;
                });
                
                grid.innerHTML = `
                    <div class="kpi-card" style="border-color: var(--primary);">
                        <div class="value">${aniloxData.length}</div><div class="label">Total de Anilox</div>
                    </div>
                    <div class="kpi-card" style="border-color: var(--success);">
                        <div class="value">${avgLife}%</div><div class="label">Vida Útil Média</div>
                    </div>
                    <div class="kpi-card" style="border-color: var(--danger);">
                        <div class="value">${criticalVolumeCount}</div><div class="label">Volume Crítico</div>
                    </div>
                    <div class="kpi-card" style="border-color: var(--warning);">
                        <div class="value">${criticalCleaningCount}</div><div class="label">Limpeza Atrasada</div>
                    </div>
                    <div class="performance-card">
                        <h2>Performance de Lavagens (Últimos 7 Dias)</h2>
                        <div class="weekly-progress-container">${weeklyProgressHTML}</div>
                    </div>
                `;
            },
            createChart: (canvasId, type, labels, datasets) => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                if (charts[canvasId]) charts[canvasId].destroy();
                charts[canvasId] = new Chart(ctx, {
                    type, data: { labels, datasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: datasets.length > 1 } }, scales: { y: { beginAtZero: true } } }
                });
            },
            table: () => {
                const tableBody = document.getElementById('aniloxTableBody');
                const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

                const filteredData = searchTerm
                    ? aniloxData.filter(a => a.id.toLowerCase().includes(searchTerm))
                    : [...aniloxData];

                if (filteredData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="10" class="placeholder">${searchTerm ? 'Nenhum anilox encontrado.' : 'Nenhum anilox cadastrado.'}</td></tr>`;
                    return;
                }

                const getSortValue = (a, col) => {
                    const lm = a.historico.length > 0 ? a.historico.slice().sort((d1, d2) => new Date(d2.data) - new Date(d1.data))[0] : { bcmAtual: -1, data: null };
                    const lw = a.lavagens.length > 0 ? a.lavagens.sort().reverse()[0] : null;
                    const lad = lw && (!lm.data || new Date(lw) > new Date(lm.data)) ? lw : lm.data;
                    switch (col) {
                        case 'id': return isNaN(parseInt(a.id, 10)) ? a.id : parseInt(a.id, 10);
                        case 'bcm_original': return a.bcm_original;
                        case 'bcm_atual': return lm.bcmAtual;
                        case 'vida_util': return (lm.bcmAtual / a.bcm_original) * 100;
                        case 'ultima_atividade': return lad ? new Date(lad) : new Date(0);
                        default: return a[col] || '';
                    }
                };

                const sortedData = filteredData.sort((a, b) => {
                    const valA = getSortValue(a, currentSort.column);
                    const valB = getSortValue(b, currentSort.column);
                    if (typeof valA === 'string') {
                        return currentSort.direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                    return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                });

                document.querySelectorAll('th .sort-indicator').forEach(el => el.textContent = '');
                const activeTh = document.querySelector(`th[onclick="render.sortTable('${currentSort.column}')"] .sort-indicator`);
                if (activeTh) activeTh.textContent = currentSort.direction === 'asc' ? '▲' : '▼';

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                tableBody.innerHTML = '';

                sortedData.forEach(anilox => {
                    const latestMeasurement = anilox.historico.length > 0 ? anilox.historico.slice().sort((d1, d2) => new Date(d2.data) - new Date(d1.data))[0] : { bcmAtual: 'N/A', data: null };
                    const life = (latestMeasurement.bcmAtual / anilox.bcm_original) * 100;
                    let volStatusBadge = `<span class="status-badge status-na">N/A</span>`;
                    if (!isNaN(life)) {
                        if (life < settings.critical) volStatusBadge = `<span class="status-badge status-critico">Crítico</span>`;
                        else if (life < settings.attention) volStatusBadge = `<span class="status-badge status-atencao">Atenção</span>`;
                        else volStatusBadge = `<span class="status-badge status-ok">OK</span>`;
                    }

                    const latestWash = anilox.lavagens.length > 0 ? anilox.lavagens.sort().reverse()[0] : null;
                    const lastActivityDateStr = latestWash && (!latestMeasurement.data || new Date(latestWash) > new Date(latestMeasurement.data)) ? latestWash : latestMeasurement.data;
                    let washStatusBadge = `<span class="status-badge status-ok">OK</span>`, lastActivityDateFormatted = "N/A";

                    if (lastActivityDateStr) {
                        const lastActivityDate = new Date(lastActivityDateStr + 'T12:00:00Z');
                        lastActivityDateFormatted = lastActivityDate.toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                        const diffDays = Math.floor((today - lastActivityDate) / 86400000);
                        if (diffDays >= settings.washCritical) washStatusBadge = `<span class="status-badge status-critico">Crítico (${diffDays}d)</span>`;
                        else if (diffDays >= settings.washAttention) washStatusBadge = `<span class="status-badge status-atencao">Atenção (${diffDays}d)</span>`;
                    }
                    
                    // Format detailed state
                    let estadoHtml = '';
                    if (anilox.status_especial) estadoHtml += `<div style="font-weight: bold; color: var(--danger); margin-bottom: 5px;">${anilox.status_especial}</div>`;
                    if (anilox.riscos_ld) estadoHtml += `<div><strong>Risc. LD:</strong> ${anilox.riscos_ld}</div>`;
                    if (anilox.riscos_le) estadoHtml += `<div><strong>Risc. LE:</strong> ${anilox.riscos_le}</div>`;
                    if (anilox.batidas_ld) estadoHtml += `<div><strong>Bat. LD:</strong> ${anilox.batidas_ld}</div>`;
                    if (anilox.batidas_le) estadoHtml += `<div><strong>Bat. LE:</strong> ${anilox.batidas_le}</div>`;
                    if (anilox.observacoes_gerais) estadoHtml += `<div><strong>Obs:</strong> ${anilox.observacoes_gerais}</div>`;
                    if (!estadoHtml) estadoHtml = 'N/A';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${anilox.id}</strong></td> <td>${anilox.bcm_original.toFixed(1)}</td>
                        <td>${typeof latestMeasurement.bcmAtual === 'number' ? latestMeasurement.bcmAtual.toFixed(1) : 'N/A'}</td>
                        <td>${!isNaN(life) ? life.toFixed(1) + '%' : 'N/A'}</td> <td>${anilox.lineatura}</td>
                        <td class="estado-cell">${estadoHtml}</td>
                        <td>${lastActivityDateFormatted}</td> <td>${volStatusBadge}</td> <td>${washStatusBadge}</td>
                        <td>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 4px;">
                                <button class="btn-small" style="background-color: var(--success);" onclick="openWashModal('${anilox.id}')">Lavar</button>
                                <button class="btn-small" style="background-color: var(--primary);" onclick="openMeasurementModal('${anilox.id}')">Medir</button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px;">
                                <button class="btn-small" onclick="openEditModal('${anilox.id}')">Estado</button>
                                <button class="btn-small" style="background-color: var(--text-light);" onclick="showChart('${anilox.id}')">Histórico</button>
                            </div>
                        </td>`;
                    tableBody.appendChild(row);
                });
            }
        };

        function openWashModal(id) {
            document.getElementById('washAniloxId').value = id;
            document.getElementById('modalWashAniloxId').textContent = id;
            document.getElementById('washDate').valueAsDate = new Date();
            ui.openModal('addWashModal');
        }

        function openMeasurementModal(id) {
            document.getElementById('measurementAniloxId').value = id;
            document.getElementById('modalAniloxId').textContent = id;
            document.getElementById('bcmAtualInput').value = '';
            document.getElementById('measurementDate').valueAsDate = new Date();
            ui.openModal('addMeasurementModal');
        }

        function openEditModal(id) {
            const anilox = aniloxData.find(a => a.id === id);
            if (!anilox) return;
            document.getElementById('editAniloxId').value = anilox.id;
            document.getElementById('modalEditAniloxId').textContent = anilox.id;
            document.getElementById('editRiscosLD').value = anilox.riscos_ld || '';
            document.getElementById('editRiscosLE').value = anilox.riscos_le || '';
            document.getElementById('editBatidasLD').value = anilox.batidas_ld || '';
            document.getElementById('editBatidasLE').value = anilox.batidas_le || '';
            document.getElementById('editStatusEspecial').value = anilox.status_especial || '';
            document.getElementById('editObservacoes').value = anilox.observacoes_gerais || '';
            ui.openModal('editAniloxModal');
        }

        function showChart(id) {
            const anilox = aniloxData.find(a => a.id === id);
            if (!anilox || anilox.historico.length === 0) return ui.showToast('Nenhum histórico de medição para este anilox.', 'error');
            const sortedHistory = [...anilox.historico].sort((a, b) => new Date(a.data) - new Date(b.data));
            const datasets = [
                { label: 'BCM Atual', data: sortedHistory.map(h => h.bcmAtual), borderColor: 'var(--primary)', backgroundColor: 'rgba(36, 99, 235, 0.1)', tension: 0.1, fill: true },
                { label: 'BCM Original', data: Array(sortedHistory.length).fill(anilox.bcm_original), borderColor: 'var(--success)', borderDash: [5, 5], pointRadius: 0, fill: false },
                { label: 'Limite Crítico', data: Array(sortedHistory.length).fill(anilox.bcm_original * (settings.critical / 100)), borderColor: 'var(--danger)', borderDash: [5, 5], pointRadius: 0, fill: false }
            ];
            document.getElementById('chartModalTitle').innerText = `Histórico de Volume do Anilox Nº ${anilox.id}`;
            render.createChart('aniloxChart', 'line', sortedHistory.map(h => new Date(h.data + 'T12:00:00Z').toLocaleDateString('pt-BR', {timeZone: 'UTC'})), datasets);
            ui.openModal('chartModal');
        }

        function generateComprehensiveReport() {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            if (!startDateStr || !endDateStr) return ui.showToast('Selecione as datas de início e fim.', 'error');

            const startUTC = new Date(startDateStr + 'T00:00:00Z');
            const endUTC = new Date(endDateStr + 'T23:59:59Z');
            const resultsDiv = document.getElementById('reportResults');

            const reportData = aniloxData.map(anilox => {
                const sortedHistory = anilox.historico.slice().sort((a,b) => new Date(a.data) - new Date(b.data));
                const washesInPeriod = anilox.lavagens.filter(w => { const d = new Date(w + 'T12:00:00Z'); return d >= startUTC && d <= endUTC; });
                const measurementsInPeriod = sortedHistory.filter(h => { const d = new Date(h.data + 'T12:00:00Z'); return d >= startUTC && d <= endUTC; });
                
                if (washesInPeriod.length === 0 && measurementsInPeriod.length === 0) return null;

                // --- INÍCIO DA CORREÇÃO ---
                const washCount = washesInPeriod.length; // 1. Armazena a contagem correta antes de modificar o array.
                const lastWashInPeriod = washCount > 0 ? washesInPeriod.sort().pop() : null; // 2. Agora, modifica o array para obter a última data.
                // --- FIM DA CORREÇÃO ---

                const lastMeasurementBefore = sortedHistory.filter(h => new Date(h.data + 'T12:00:00Z') < startUTC).pop();
                const initialBCM = measurementsInPeriod[0]?.bcmAtual || lastMeasurementBefore?.bcmAtual;
                const finalBCM = measurementsInPeriod.length > 0 ? measurementsInPeriod[measurementsInPeriod.length - 1].bcmAtual : initialBCM;
                const loss = (initialBCM && finalBCM) ? initialBCM - finalBCM : 0;
                
                // 3. Usa a variável 'washCount' que foi armazenada anteriormente.
                return { id: anilox.id, washCount: washCount, lastWashDate: lastWashInPeriod, measurementCount: measurementsInPeriod.length, initialBCM, finalBCM, loss };
            }).filter(Boolean);

            resultsDiv.innerHTML = `<h3 style="margin-bottom: 15px;">Análise de ${startUTC.toLocaleDateString('pt-BR', {timeZone: 'UTC'})} a ${endUTC.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</h3>`;
            if (reportData.length === 0) {
                resultsDiv.innerHTML += `<p class="placeholder">Nenhuma atividade registrada no período.</p>`;
                return;
            }
            let tableHTML = `<div class="table-container"><table><thead><tr>
                <th>Nº Anilox</th><th>Lavagens</th><th>Última Lavagem no Período</th><th>Medições</th><th>Volume Inicial</th><th>Volume Final</th><th>Perda de Volume</th>
            </tr></thead><tbody>`;
            reportData.forEach(item => {
                const lastWashFormatted = item.lastWashDate ? new Date(item.lastWashDate + 'T12:00:00Z').toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'N/A';
                tableHTML += `<tr>
                    <td><strong>${item.id}</strong></td> <td>${item.washCount}</td> <td>${lastWashFormatted}</td> <td>${item.measurementCount}</td>
                    <td>${item.initialBCM?.toFixed(2) || 'N/A'}</td> <td>${item.finalBCM?.toFixed(2) || 'N/A'}</td>
                    <td style="color:${item.loss > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: 600;">${item.loss.toFixed(2)}</td>
                </tr>`;
            });
            resultsDiv.innerHTML += tableHTML + `</tbody></table></div>`;
        }

        async function initializeApp() {
            // --- Render Modal Structures ---
            document.getElementById('addWashModal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h2>Registrar Lavagem (Nº <span id="modalWashAniloxId"></span>)</h2><span class="close-button" onclick="ui.closeModal('addWashModal')">&times;</span></div><form id="addWashForm" class="modal-body"><input type="hidden" id="washAniloxId"><div class="input-group"><label for="washDate">Data da Lavagem</label><input type="date" id="washDate" required></div><button type="submit">Salvar</button></form></div>`;
            document.getElementById('addMeasurementModal').innerHTML = `<div class="modal-content" style="max-width: 500px;"><div class="modal-header"><h2>Adicionar Medição (Nº <span id="modalAniloxId"></span>)</h2><span class="close-button" onclick="ui.closeModal('addMeasurementModal')">&times;</span></div><form id="addMeasurementForm" class="modal-body"><input type="hidden" id="measurementAniloxId"><div class="input-group"><label for="bcmAtualInput">Novo BCM</label><input type="number" step="0.1" id="bcmAtualInput" required></div><div class="input-group"><label for="measurementDate">Data</label><input type="date" id="measurementDate" required></div><button type="submit">Salvar</button></form></div>`;
            document.getElementById('chartModal').innerHTML = `<div class="modal-content modal-xl"><div class="modal-header"><h2 id="chartModalTitle">Histórico</h2><span class="close-button" onclick="ui.closeModal('chartModal')">&times;</span></div><div class="modal-body" id="chart-container"><canvas id="aniloxChart"></canvas></div></div>`;
            
            // --- NEW/MODIFIED MODALS ---
            document.getElementById('addAniloxModal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2>Adicionar Novo Anilox</h2><span class="close-button" onclick="ui.closeModal('addAniloxModal')">&times;</span></div>
                <form id="addAniloxForm" class="modal-body" style="display: flex; flex-direction: column; gap: 20px;">
                    <div class="controls-grid">
                        <div class="input-group"><label for="newAniloxId">Nº</label><input type="text" id="newAniloxId" required></div>
                        <div class="input-group"><label for="newBcmOriginal">BCM Original</label><input type="number" step="0.1" id="newBcmOriginal" required></div>
                        <div class="input-group"><label for="newLineatura">Lineatura</label><input type="text" id="newLineatura" required></div>
                    </div>
                    <hr>
                    <p style="font-weight: 500; color: var(--primary);">Primeira Medição (Obrigatória)</p>
                    <div class="controls-grid">
                        <div class="input-group"><label for="newBcmAtual">BCM Atual</label><input type="number" step="0.1" id="newBcmAtual" required></div>
                        <div class="input-group"><label for="newMeasurementDate">Data Medição</label><input type="date" id="newMeasurementDate" required></div>
                    </div>
                    <hr>
                    <p style="font-weight: 500; color: var(--primary);">Apontamento do Estado (Opcional)</p>
                    <div class="controls-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="input-group"><label for="newRiscosLD">Riscos Lado Direito</label><textarea id="newRiscosLD" placeholder="Ex: 34, 44, 510 à 525"></textarea></div>
                        <div class="input-group"><label for="newRiscosLE">Riscos Lado Esquerdo</label><textarea id="newRiscosLE" placeholder="Ex: 43, 57, 175"></textarea></div>
                        <div class="input-group"><label for="newBatidasLD">Batidas Lado Direito</label><textarea id="newBatidasLD" placeholder="Ex: 59, 63, 98"></textarea></div>
                        <div class="input-group"><label for="newBatidasLE">Batidas Lado Esquerdo</label><textarea id="newBatidasLE" placeholder="Ex: 500 à 510"></textarea></div>
                    </div>
                    <div class="input-group"><label for="newStatusEspecial">Status Especial</label><input type="text" id="newStatusEspecial" placeholder="Ex: REGRAVAÇÃO"></div>
                    <div class="input-group"><label for="newObservacoes">Observações Gerais</label><textarea id="newObservacoes" placeholder="Manchas, etc."></textarea></div>
                    <button type="submit">Salvar Anilox</button>
                </form></div>`;

            document.getElementById('editAniloxModal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2>Apontamento do Estado do Anilox Nº <span id="modalEditAniloxId"></span></h2><span class="close-button" onclick="ui.closeModal('editAniloxModal')">&times;</span></div>
                <form id="editAniloxForm" class="modal-body" style="display: flex; flex-direction: column; gap: 20px;">
                    <input type="hidden" id="editAniloxId">
                    <div class="controls-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="input-group"><label for="editRiscosLD">Riscos Lado Direito</label><textarea id="editRiscosLD" placeholder="Ex: 34, 44, 510 à 525"></textarea></div>
                        <div class="input-group"><label for="editRiscosLE">Riscos Lado Esquerdo</label><textarea id="editRiscosLE" placeholder="Ex: 43, 57, 175"></textarea></div>
                        <div class="input-group"><label for="editBatidasLD">Batidas Lado Direito</label><textarea id="editBatidasLD" placeholder="Ex: 59, 63, 98"></textarea></div>
                        <div class="input-group"><label for="editBatidasLE">Batidas Lado Esquerdo</label><textarea id="editBatidasLE" placeholder="Ex: 500 à 510"></textarea></div>
                    </div>
                    <div class="input-group"><label for="editStatusEspecial">Status Especial</label><input type="text" id="editStatusEspecial" placeholder="Ex: REGRAVAÇÃO"></div>
                    <div class="input-group"><label for="editObservacoes">Observações Gerais</label><textarea id="editObservacoes" placeholder="Manchas, etc."></textarea></div>
                    <button type="submit">Salvar Estado</button>
                </form></div>`;
            
            // --- Fetch Data and Render ---
            [settings, aniloxData] = await Promise.all([db.fetchSettings(), db.fetchAniloxData()]);
            render.populateSettingsForm(settings);
            render.all();

            // --- Global Functions ---
            window.showTab = ui.showTab; window.openModal = ui.openModal; window.closeModal = ui.closeModal;
            window.openWashModal = openWashModal; window.openMeasurementModal = openMeasurementModal;
            window.openEditModal = openEditModal; window.showChart = showChart; window.generateComprehensiveReport = generateComprehensiveReport;

            // --- Event Listeners ---
            document.getElementById('searchInput').addEventListener('input', render.table);

            document.getElementById('saveSettingsBtn').addEventListener('click', (e) => ui.handleFormSubmit(e.currentTarget, async () => {
                const newSettings = {
                    attention: parseFloat(document.getElementById('attentionThreshold').value), critical: parseFloat(document.getElementById('criticalThreshold').value),
                    washAttention: parseInt(document.getElementById('washAttentionDays').value, 10), washCritical: parseInt(document.getElementById('washCriticalDays').value, 10)
                };
                if (Object.values(newSettings).some(isNaN) || newSettings.attention <= newSettings.critical) throw new Error('Valores inválidos. Atenção deve ser > Crítico.');
                settings = newSettings;
                await db.saveSettings(settings);
                render.all();
                ui.showToast('Configurações salvas!');
            }));

            document.getElementById('resetData').addEventListener('click', (e) => {
                if (confirm('ATENÇÃO! Isso apagará TODOS os dados. Deseja continuar?')) {
                    ui.handleFormSubmit(e.currentTarget, async () => {
                        await db.resetAllData();
                        ui.showToast('Dados resetados.');
                        setTimeout(() => window.location.reload(), 1500);
                    });
                }
            });

            document.getElementById('addWashForm').addEventListener('submit', (e) => {
                e.preventDefault();
                ui.handleFormSubmit(e.currentTarget.querySelector('button'), async () => {
                    const id = document.getElementById('washAniloxId').value, date = document.getElementById('washDate').value;
                    if (!date) throw new Error('Data é obrigatória.');
                    const anilox = aniloxData.find(a => a.id === id);
                    anilox.lavagens.push(date);
                    await db.updateAniloxRecord(id, { lavagens: anilox.lavagens });
                    render.all();
                    ui.closeModal('addWashModal');
                    e.target.reset();
                    ui.showToast('Lavagem registrada!');
                });
            });

            document.getElementById('addMeasurementForm').addEventListener('submit', (e) => {
                e.preventDefault();
                ui.handleFormSubmit(e.currentTarget.querySelector('button'), async () => {
                    const id = document.getElementById('measurementAniloxId').value;
                    const bcmAtual = parseFloat(document.getElementById('bcmAtualInput').value), data = document.getElementById('measurementDate').value;
                    if (isNaN(bcmAtual) || !data) throw new Error('BCM e Data são obrigatórios.');
                    const anilox = aniloxData.find(a => a.id === id);
                    anilox.historico.push({ data, bcmAtual });
                    await db.updateAniloxRecord(id, { historico: anilox.historico });
                    render.all();
                    ui.closeModal('addMeasurementModal');
                    e.target.reset();
                    ui.showToast('Medição salva!');
                });
            });

            document.getElementById('addAniloxForm').addEventListener('submit', (e) => {
                e.preventDefault();
                ui.handleFormSubmit(e.currentTarget.querySelector('button'), async () => {
                    const newAnilox = {
                        id: document.getElementById('newAniloxId').value.trim(),
                        bcm_original: parseFloat(document.getElementById('newBcmOriginal').value),
                        lineatura: document.getElementById('newLineatura').value.trim(),
                        historico: [{ data: document.getElementById('newMeasurementDate').value, bcmAtual: parseFloat(document.getElementById('newBcmAtual').value) }],
                        lavagens: [],
                        riscos_ld: document.getElementById('newRiscosLD').value.trim(),
                        riscos_le: document.getElementById('newRiscosLE').value.trim(),
                        batidas_ld: document.getElementById('newBatidasLD').value.trim(),
                        batidas_le: document.getElementById('newBatidasLE').value.trim(),
                        status_especial: document.getElementById('newStatusEspecial').value.trim(),
                        observacoes_gerais: document.getElementById('newObservacoes').value.trim()
                    };
                    if (!newAnilox.id || !newAnilox.lineatura || isNaN(newAnilox.bcm_original) || isNaN(newAnilox.historico[0].bcmAtual) || !newAnilox.historico[0].data) throw new Error('Preencha os campos obrigatórios.');
                    if (aniloxData.some(a => a.id === newAnilox.id)) throw new Error(`O anilox Nº ${newAnilox.id} já existe.`);
                    const [addedAnilox] = await db.addAniloxRecord(newAnilox);
                    aniloxData.push(addedAnilox);
                    render.all();
                    ui.closeModal('addAniloxModal');
                    e.target.reset();
                    ui.showToast('Novo anilox adicionado!');
                });
            });

            document.getElementById('editAniloxForm').addEventListener('submit', (e) => {
                e.preventDefault();
                ui.handleFormSubmit(e.currentTarget.querySelector('button'), async () => {
                    const id = document.getElementById('editAniloxId').value;
                    const updatedData = {
                        riscos_ld: document.getElementById('editRiscosLD').value.trim(),
                        riscos_le: document.getElementById('editRiscosLE').value.trim(),
                        batidas_ld: document.getElementById('editBatidasLD').value.trim(),
                        batidas_le: document.getElementById('editBatidasLE').value.trim(),
                        status_especial: document.getElementById('editStatusEspecial').value.trim(),
                        observacoes_gerais: document.getElementById('editObservacoes').value.trim()
                    };
                    await db.updateAniloxRecord(id, updatedData);
                    const anilox = aniloxData.find(a => a.id === id);
                    Object.assign(anilox, updatedData);
                    render.all();
                    ui.closeModal('editAniloxModal');
                    ui.showToast('Estado do anilox atualizado!');
                });
            });

            document.querySelectorAll('.modal-overlay').forEach(modal => modal.addEventListener('click', (e) => { if (e.target === modal) ui.closeModal(modal.id); }));
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>
