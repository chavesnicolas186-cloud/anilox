<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Anilox</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary: #2463EB; --secondary: #fd7e14; --success: #20c997; --danger: #e84a5f; --warning: #ffc107;
            --bg-light: #f4f6f9; --bg-card: #ffffff; --text-dark: #333333; --text-light: #6c757d; --text-white: #ffffff;
            --border: #dee2e6; --card-shadow: 0 6px 20px rgba(0, 0, 0, 0.07);
            --font-primary: 'Poppins', sans-serif; --font-mono: 'JetBrains Mono', monospace;
            --success-rgb: 32, 201, 151; --warning-rgb: 255, 193, 7; --danger-rgb: 232, 74, 95;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
            font-family: var(--font-primary); line-height: 1.6; color: var(--text-dark);
            background-color: var(--bg-light); padding: 20px;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        .main-container {
            max-width: 1500px; margin: 10px auto; background-color: var(--bg-card);
            padding: 30px 40px; border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--card-shadow);
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; flex-wrap: wrap; gap: 20px;
        }
        h1 {
            font-weight: 700; color: var(--primary); font-size: 1.8rem;
            display: flex; align-items: center; gap: 15px;
        }
        h2 {
            margin-bottom: 20px; font-size: 1.3rem; border-bottom: 3px solid var(--secondary);
            padding-bottom: 8px; font-weight: 600; color: var(--primary);
        }
        .nav-tabs {
            display: flex; margin-bottom: 30px; gap: 8px; border-bottom: 1px solid var(--border);
        }
        .nav-tab {
            padding: 10px 20px; cursor: pointer; background-color: transparent;
            border: 1px solid transparent; border-bottom: 3px solid transparent;
            border-radius: 6px 6px 0 0; font-weight: 500; font-size: 0.9rem;
            color: var(--text-light); transition: all 0.2s ease-in-out; margin-bottom: -1px;
        }
        .nav-tab:hover { background-color: var(--bg-light); color: var(--primary); }
        .nav-tab.active {
            border-color: var(--border) var(--border) var(--bg-card) var(--border);
            border-bottom-color: var(--primary); color: var(--primary); font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .controls-section {
            display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px;
            padding: 25px; border: 1px solid var(--border); border-radius: 8px; background-color: var(--bg-light);
        }
        .controls-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; align-items: flex-end;
        }
        .input-group { display: flex; flex-direction: column; }
        label {
            font-family: var(--font-mono); font-weight: 500; font-size: 0.8rem;
            color: var(--text-light); margin-bottom: 8px; text-transform: uppercase;
        }
        input[type="text"], input[type="number"], input[type="date"] {
            padding: 12px 15px; border: 1px solid var(--border); border-radius: 6px;
            font-size: 0.95rem; font-family: var(--font-mono); background-color: #fff;
            color: var(--text-dark); width: 100%; transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(36, 99, 235, 0.2); }
        
        button {
            background-color: var(--primary); color: var(--text-white); border: none;
            padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 0.9rem;
            font-weight: 600; font-family: var(--font-primary); text-transform: uppercase;
            letter-spacing: 0.8px; transition: all 0.2s ease-in-out; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button:hover { background-color: var(--secondary); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transform: translateY(-2px); }
        button.btn-danger { background-color: var(--danger); }
        button.btn-danger:hover { background-color: #c2303f; }
        button.btn-info { background-color: #17a2b8; }
        button.btn-info:hover { background-color: #138496; }
        button.btn-secondary { background-color: var(--text-light); }
        button.btn-secondary:hover { background-color: var(--text-dark); }
        button.btn-success { background-color: var(--success); }
        button.btn-success:hover { background-color: #198754; }
        .btn-small { padding: 6px 12px; font-size: 0.75rem; margin: 0 2px; width: auto; display: inline-block; }
        
        .table-container {
            overflow-x: auto; border: 1px solid var(--border); border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-top: 20px; max-height: 70vh;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td {
            padding: 12px 15px; text-align: center; font-family: var(--font-mono);
            vertical-align: middle; border-bottom: 1px solid var(--border);
        }
        th {
            background-color: var(--bg-light); color: var(--text-dark); font-weight: 600;
            font-family: var(--font-primary); text-transform: uppercase; letter-spacing: 0.5px;
            font-size: 0.75rem; position: sticky; top: 0; z-index: 1;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8f9fa; }
        .status-ok { background-color: rgba(var(--success-rgb), 0.05); }
        .status-atencao { background-color: rgba(var(--warning-rgb), 0.1); }
        .status-critico { background-color: rgba(var(--danger-rgb), 0.08); }
        
        .status-badge {
            padding: 4px 10px; border-radius: 12px; font-size: 0.75rem;
            font-weight: 600; color: var(--text-white); font-family: var(--font-primary);
            text-transform: uppercase;
        }
        .status-badge.status-ok { background-color: var(--success); }
        .status-badge.status-atencao { background-color: var(--warning); color: var(--text-dark); }
        .status-badge.status-critico { background-color: var(--danger); }

        .modal-overlay {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: var(--bg-card); padding: 30px 40px; border: 1px solid var(--border);
            border-radius: 12px; box-shadow: var(--card-shadow); width: 90%; max-width: 500px; position: relative;
        }
        .modal-content.modal-xl { max-width: 90vw; }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--border);
        }
        .modal-header h2 { margin: 0; border: none; padding: 0; font-size: 1.3rem; }
        .close-button { color: var(--text-light); font-size: 2rem; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-button:hover { color: var(--danger); }
        .modal-body form { display: flex; flex-direction: column; gap: 20px; }
        #chart-container { position: relative; height: 60vh; width: 100%; }
        #reportResults .placeholder, #aniloxTableBody .placeholder { color: var(--text-light); text-align: center; padding: 40px; font-style: italic; }
        #settings-feedback { color: var(--success); font-weight: 600; margin-left: 15px; opacity: 0; transition: opacity 0.3s; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .main-container { padding: 20px; }
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
            h1 { font-size: 1.4rem; flex-wrap: wrap; }
            .controls-grid { grid-template-columns: 1fr; }
            table { font-size: 0.8rem; }
            th, td { padding: 10px; }
            button { width: 100%; }
            .btn-small { width: auto; display: inline-block; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header">
            <h1><img src="https://flexopower.com.br/wp-content/uploads/2020/02/logo-flexopower.png" alt="Logo" height="40"> Gestão de Anilox</h1>
            <button onclick="openModal('addAniloxModal')">+ Adicionar Novo Anilox</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab(event,'aniloxTab')">Anilox</button>
            <button class="nav-tab" onclick="showTab(event,'reportTab')">Relatório de Lavagens</button>
            <button class="nav-tab" onclick="showTab(event,'settingsTab')">Configurações</button>
        </div>

        <!-- TAB ANILOX -->
        <div id="aniloxTab" class="tab-content active">
            <h2>Lista de Anilox</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nº</th>
                            <th>BCM Original</th>
                            <th>BCM Atual</th>
                            <th>% Vida Útil</th>
                            <th>Lineatura</th>
                            <th>Últ. Atividade</th>
                            <th>Status Volume</th>
                            <th>Status Limpeza</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="aniloxTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- TAB RELATÓRIO -->
        <div id="reportTab" class="tab-content">
            <h2>Relatório de Frequência de Lavagens</h2>
            <div class="controls-section">
                <div class="controls-grid">
                    <div class="input-group">
                        <label for="startDate">Data de Início</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="input-group">
                        <label for="endDate">Data de Fim</label>
                        <input type="date" id="endDate">
                    </div>
                    <button onclick="generateWashReport()">Gerar Relatório</button>
                </div>
            </div>
            <div id="reportResults">
                <p class="placeholder">Selecione um período e clique em "Gerar Relatório" para ver os resultados.</p>
            </div>
        </div>

        <!-- TAB CONFIGURAÇÕES -->
        <div id="settingsTab" class="tab-content">
            <h2>Configurações de Alerta de Volume</h2>
            <div class="controls-section">
                <div class="controls-grid">
                    <div class="input-group">
                        <label for="attentionThreshold">Atenção se BCM for menor que (% original):</label>
                        <input type="number" id="attentionThreshold">
                    </div>
                    <div class="input-group">
                        <label for="criticalThreshold">Crítico (Regravar) se BCM for menor que (% original):</label>
                        <input type="number" id="criticalThreshold">
                    </div>
                </div>
            </div>
            <h2>Configurações de Alerta de Limpeza</h2>
            <div class="controls-section">
                <div class="controls-grid">
                    <div class="input-group">
                        <label for="washAttentionDays">Atenção após (dias sem limpar):</label>
                        <input type="number" id="washAttentionDays">
                    </div>
                    <div class="input-group">
                        <label for="washCriticalDays">Crítico após (dias sem limpar):</label>
                        <input type="number" id="washCriticalDays">
                    </div>
                </div>
            </div>
            <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                <button id="saveSettingsBtn">Salvar Configurações</button>
                <span id="settings-feedback"></span>
            </div>
            <h2 style="margin-top: 40px;">Gerenciamento de Dados</h2>
            <div class="controls-section">
                 <button id="resetData" class="btn-danger">Resetar Todos os Dados</button>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="addMeasurementModal" class="modal-overlay"></div>
    <div id="addAniloxModal" class="modal-overlay"></div>
    <div id="chartModal" class="modal-overlay"></div>
    <div id="addWashModal" class="modal-overlay"></div>

    <script>
        // --- SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://qonapwpnnknvnhvjysjc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvbmFwd3Bubmtudm5odmp5c2pjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NDUwMTIsImV4cCI6MjA3NDEyMTAxMn0.DqkQuENorS1cH4mTyyGvWdohfS5ac4AyO3nufrbBf5E';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase client inicializado.");

        // --- VARIÁVEIS GLOBAIS ---
        let aniloxData = [];
        let settings = {};
        let chartInstance = null;

        const defaultSettings = {
            attention: 90,
            critical: 80,
            washAttention: 3,
            washCritical: 7
        };

        // --- CAMADA DE ACESSO A DADOS ---
        const db = {
            fetchAniloxData: async () => {
                const { data, error } = await supabaseClient.from('anilox').select('*');
                if (error) {
                    console.error("Erro ao buscar dados do anilox:", error);
                    return [];
                }
                return data;
            },
            updateAniloxRecord: async (anilox) => {
                const { data, error } = await supabaseClient
                    .from('anilox')
                    .update(anilox)
                    .eq('id', anilox.id)
                    .select(); // Adicionado .select() para retornar o dado e confirmar a operação
                if (error) {
                    console.error("Erro ao atualizar anilox:", error);
                    throw error; // Lança o erro para ser tratado no 'catch'
                }
                return data;
            },
            addAniloxRecord: async (anilox) => {
                const { data, error } = await supabaseClient
                    .from('anilox')
                    .insert(anilox)
                    .select();
                if (error) {
                    console.error("Erro ao adicionar anilox:", error);
                    throw error;
                }
                return data;
            },
            fetchSettings: async () => {
                const { data, error } = await supabaseClient
                    .from('settings')
                    .select('config')
                    .eq('id', 1)
                    .single();
                if (error || !data) {
                    console.warn("Configurações não encontradas no DB, usando padrão.");
                    return defaultSettings;
                }
                return data.config;
            },
            saveSettings: async (settings) => {
                const { error } = await supabaseClient
                    .from('settings')
                    .upsert({ id: 1, config: settings });
                if (error) console.error("Erro ao salvar configurações:", error);
            },
            resetAllData: async () => {
                console.log("Deletando todos os registros...");
                const { error: aniloxError } = await supabaseClient
                    .from('anilox')
                    .delete()
                    .neq('id', 'dummy_id_to_delete_all');
                const { error: settingsError } = await supabaseClient
                    .from('settings')
                    .delete()
                    .eq('id', 1);

                if(aniloxError) console.error("Erro ao deletar anilox:", aniloxError);
                if(settingsError) console.error("Erro ao deletar settings:", settingsError);
            }
        };
        
        // --- LÓGICA DAS ABAS ---
        function showTab(evt, tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        // --- MODAIS ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

        // --- POPULAR CONFIG FORM ---
        function populateSettingsForm(settings) {
            document.getElementById('attentionThreshold').value = settings.attention;
            document.getElementById('criticalThreshold').value = settings.critical;
            document.getElementById('washAttentionDays').value = settings.washAttention;
            document.getElementById('washCriticalDays').value = settings.washCritical;
        }

        // --- RENDER TABELA ---
        function renderTable() {
            const tableBody = document.getElementById('aniloxTableBody');
            tableBody.innerHTML = '';
            
            if (aniloxData.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="placeholder">Nenhum anilox cadastrado. Clique em "+ Adicionar Novo Anilox" para começar.</td></tr>`;
                return;
            }

            const sortedData = [...aniloxData].sort((a, b) => {
                const idA = parseInt(a.id, 10);
                const idB = parseInt(b.id, 10);
                return (isNaN(idA) || isNaN(idB)) ? (''+a.id).localeCompare(''+b.id) : idA - idB;
            });

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            sortedData.forEach(anilox => {
                // ### ALTERAÇÃO CRÍTICA AQUI! ###
                // A medição mais recente é a ÚLTIMA do array, não a primeira após ordenar por data.
                // Isso corrige o bug de múltiplas medições no mesmo dia.
                const latestMeasurement = anilox.historico.length > 0
                    ? anilox.historico[anilox.historico.length - 1]
                    : { bcmAtual: 'N/A', data: null };

                const life = (latestMeasurement.bcmAtual / anilox.bcm_original) * 100;

                let volStatusClass = 'status-ok', volStatusText = 'OK';
                if (!isNaN(life)) {
                    if (life < settings.critical) { 
                        volStatusClass = 'status-critico'; volStatusText = 'Crítico'; 
                    } else if (life < settings.attention) { 
                        volStatusClass = 'status-atencao'; volStatusText = 'Atenção'; 
                    }
                }

                const latestWash = anilox.lavagens.length > 0 ? anilox.lavagens.sort().reverse()[0] : null;
                const lastActivityDateStr = latestWash && (!latestMeasurement.data || new Date(latestWash) > new Date(latestMeasurement.data))
                    ? latestWash
                    : latestMeasurement.data;

                let washStatusBadge = `<span class="status-badge status-ok">OK</span>`;
                let lastActivityDateFormatted = "N/A";

                if (lastActivityDateStr) {
                    const lastActivityDate = new Date(lastActivityDateStr);
                    lastActivityDate.setUTCHours(12,0,0,0);

                    lastActivityDateFormatted = lastActivityDate.toLocaleDateString('pt-BR', {timeZone: 'UTC'});

                    const diffTime = today - lastActivityDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays >= settings.washCritical) {
                        washStatusBadge = `<span class="status-badge status-critico">Crítico (${diffDays}d)</span>`;
                    } else if (diffDays >= settings.washAttention) {
                        washStatusBadge = `<span class="status-badge status-atencao">Atenção (${diffDays}d)</span>`;
                    }
                }

                const row = document.createElement('tr');
                row.className = volStatusClass;
                row.innerHTML = `
                    <td><strong>${anilox.id}</strong></td>
                    <td>${anilox.bcm_original.toFixed(1)}</td>
                    <td>${typeof latestMeasurement.bcmAtual === 'number' ? latestMeasurement.bcmAtual.toFixed(1) : 'N/A'}</td>
                    <td>${!isNaN(life) ? life.toFixed(1) + '%' : 'N/A'}</td>
                    <td>${anilox.lineatura}</td>
                    <td>${lastActivityDateFormatted}</td>
                    <td>${volStatusText}</td>
                    <td>${washStatusBadge}</td>
                    <td>
                        <button class="btn-small btn-success" onclick="openWashModal('${anilox.id}')">Lavar</button>
                        <button class="btn-small btn-info" onclick="openMeasurementModal('${anilox.id}')">Medir</button>
                        <button class="btn-small btn-secondary" onclick="showChart('${anilox.id}')">Histórico</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- RELATÓRIO DE LAVAGEM ---
        function generateWashReport() {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            const resultsDiv = document.getElementById('reportResults');

            if (!startDateStr || !endDateStr) {
                alert('Por favor, selecione as datas de início e fim.');
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T23:59:59');

            const reportData = aniloxData
                .map(anilox => {
                    const washCount = anilox.lavagens.filter(washDateStr => {
                        const washDate = new Date(washDateStr + 'T12:00:00');
                        return washDate >= startDate && washDate <= endDate;
                    }).length;
                    return { id: anilox.id, count: washCount };
                })
                .filter(item => item.count > 0)
                .sort((a, b) => b.count - a.count);

            if (reportData.length === 0) {
                resultsDiv.innerHTML = `<p class="placeholder">Nenhuma lavagem registrada no período selecionado.</p>`;
                return;
            }

            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nº do Anilox</th>
                                <th>Nº de Lavagens no Período</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            reportData.forEach(item => {
                tableHTML += `<tr><td>${item.id}</td><td>${item.count}</td></tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            resultsDiv.innerHTML = tableHTML;
        }

        // --- MODAL LAVAGEM ---
        function openWashModal(id) {
            document.getElementById('washAniloxId').value = id;
            document.getElementById('modalWashAniloxId').textContent = id;
            document.getElementById('washDate').valueAsDate = new Date();
            openModal('addWashModal');
        }

        // --- MODAL MEDIÇÃO ---
        function openMeasurementModal(id) {
            document.getElementById('measurementAniloxId').value = id;
            document.getElementById('modalAniloxId').textContent = id;
            document.getElementById('bcmAtualInput').value = '';
            document.getElementById('measurementDate').valueAsDate = new Date();
            openModal('addMeasurementModal');
        }

        // --- GRÁFICO HISTÓRICO ---
        function showChart(id) {
            const anilox = aniloxData.find(a => a.id === id);
            if (!anilox) return;

            const sortedHistory = [...anilox.historico].sort((a, b) => new Date(a.data) - new Date(b.data));
            const labels = sortedHistory.map(h => new Date(h.data).toLocaleDateString('pt-BR', {timeZone: 'UTC'}));
            const dataPoints = sortedHistory.map(h => h.bcmAtual);

            const criticalThresholdValue = anilox.bcm_original * (settings.critical / 100);

            const ctx = document.getElementById('aniloxChart').getContext('2d');
            if (chartInstance) { chartInstance.destroy(); }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'BCM Atual',
                            data: dataPoints,
                            borderColor: 'var(--primary)',
                            backgroundColor: 'rgba(36, 99, 235, 0.1)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'BCM Original',
                            data: Array(labels.length).fill(anilox.bcm_original),
                            borderColor: 'var(--success)',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Limite Crítico',
                            data: Array(labels.length).fill(criticalThresholdValue),
                            borderColor: 'var(--danger)',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Histórico de Volume do Anilox Nº ${anilox.id}`,
                            font: { family: 'var(--font-primary)', size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Volume (BCM)' }
                        }
                    }
                }
            });

            document.getElementById('chartModalTitle').innerText = `Histórico do Anilox Nº ${anilox.id}`;
            openModal('chartModal');
        }

        // --- INICIALIZAÇÃO ---
        async function initializeApp() {
            // montar estrutura interna dos modais dinamicamente
            document.getElementById('addWashModal').innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Registrar Lavagem para Anilox Nº <span id="modalWashAniloxId"></span></h2>
                        <span class="close-button" onclick="closeModal('addWashModal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="addWashForm">
                            <input type="hidden" id="washAniloxId">
                            <div class="input-group">
                                <label for="washDate">Data da Lavagem</label>
                                <input type="date" id="washDate" required>
                            </div>
                            <button type="submit">Salvar Lavagem</button>
                        </form>
                    </div>
                </div>`;

            document.getElementById('addMeasurementModal').innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Adicionar Medição para Anilox Nº <span id="modalAniloxId"></span></h2>
                        <span class="close-button" onclick="closeModal('addMeasurementModal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="addMeasurementForm">
                            <input type="hidden" id="measurementAniloxId">
                            <div class="input-group">
                                <label for="bcmAtualInput">Novo BCM Atual</label>
                                <input type="number" step="0.1" id="bcmAtualInput" required>
                            </div>
                            <div class="input-group">
                                <label for="measurementDate">Data da Medição</label>
                                <input type="date" id="measurementDate" required>
                            </div>
                            <button type="submit">Salvar Medição</button>
                        </form>
                    </div>
                </div>`;

            document.getElementById('addAniloxModal').innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Adicionar Novo Anilox</h2>
                        <span class="close-button" onclick="closeModal('addAniloxModal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="addAniloxForm">
                            <div class="input-group">
                                <label for="newAniloxId">Nº do Anilox</label>
                                <input type="text" id="newAniloxId" required>
                            </div>
                            <div class="input-group">
                                <label for="newBcmOriginal">BCM Original</label>
                                <input type="number" step="0.1" id="newBcmOriginal" required>
                            </div>
                            <div class="input-group">
                                <label for="newLineatura">Lineatura</label>
                                <input type="text" id="newLineatura" required>
                            </div>

                            <hr>
                            <p>Primeira medição:</p>

                            <div class="input-group">
                                <label for="newBcmAtual">BCM Atual</label>
                                <input type="number" step="0.1" id="newBcmAtual" required>
                            </div>

                            <div class="input-group">
                                <label for="newMeasurementDate">Data da Medição</label>
                                <input type="date" id="newMeasurementDate" required>
                            </div>

                            <button type="submit">Salvar Novo Anilox</button>
                        </form>
                    </div>
                </div>`;

            document.getElementById('chartModal').innerHTML = `
                <div class="modal-content modal-xl">
                    <div class="modal-header">
                        <h2 id="chartModalTitle">Histórico do Anilox</h2>
                        <span class="close-button" onclick="closeModal('chartModal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div id="chart-container">
                            <canvas id="aniloxChart"></canvas>
                        </div>
                    </div>
                </div>`;

            // carrega settings e dados
            settings = await db.fetchSettings();
            aniloxData = await db.fetchAniloxData();

            populateSettingsForm(settings);
            renderTable();

            // listeners:
            document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
                settings = {
                    attention: parseFloat(document.getElementById('attentionThreshold').value),
                    critical: parseFloat(document.getElementById('criticalThreshold').value),
                    washAttention: parseInt(document.getElementById('washAttentionDays').value, 10),
                    washCritical: parseInt(document.getElementById('washCriticalDays').value, 10)
                };
                await db.saveSettings(settings);
                renderTable();
                const feedback = document.getElementById('settings-feedback');
                feedback.textContent = 'Salvo com sucesso!';
                feedback.style.opacity = 1;
                setTimeout(() => { feedback.style.opacity = 0; }, 2000);
            });

            document.getElementById('resetData').addEventListener('click', async () => {
                if (confirm('ATENÇÃO!\nIsso apagará TODOS os dados de anilox e configurações do banco de dados permanentemente. Deseja continuar?')) {
                    await db.resetAllData();
                    window.location.reload();
                }
            });

            document.getElementById('addWashForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('washAniloxId').value;
                const date = document.getElementById('washDate').value;
                const anilox = aniloxData.find(a => a.id === id);
                if (anilox) {
                    anilox.lavagens.push(date);
                    try {
                        await db.updateAniloxRecord(anilox);
                        renderTable();
                        closeModal('addWashModal');
                        e.target.reset();
                    } catch (error) {
                        alert("Falha ao salvar a lavagem. Verifique o console para mais detalhes.");
                    }
                }
            });

            document.getElementById('addMeasurementForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('measurementAniloxId').value;
                const bcmAtual = parseFloat(document.getElementById('bcmAtualInput').value);
                const data = document.getElementById('measurementDate').value;
                const anilox = aniloxData.find(a => a.id === id);
                if (anilox) {
                    anilox.historico.push({ data, bcmAtual });
                    try {
                        await db.updateAniloxRecord(anilox);
                        renderTable();
                        closeModal('addMeasurementModal');
                        e.target.reset();
                    } catch (error) {
                        alert("Falha ao salvar a medição. Verifique o console para mais detalhes.");
                        anilox.historico.pop(); // Reverte a adição local se a gravação falhar
                    }
                }
            });

            document.getElementById('addAniloxForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('newAniloxId').value;

                if (aniloxData.some(a => a.id === id)) {
                    alert(`Erro: O anilox com Nº ${id} já existe.`);
                    return;
                }

                const newAnilox = {
                    id: id,
                    bcm_original: parseFloat(document.getElementById('newBcmOriginal').value),
                    lineatura: document.getElementById('newLineatura').value,
                    historico: [{
                        data: document.getElementById('newMeasurementDate').value,
                        bcmAtual: parseFloat(document.getElementById('newBcmAtual').value)
                    }],
                    lavagens: []
                };

                try {
                    await db.addAniloxRecord(newAnilox);
                    aniloxData.push(newAnilox);
                    renderTable();
                    closeModal('addAniloxModal');
                    e.target.reset();
                } catch (error) {
                    alert("Falha ao adicionar novo anilox. Verifique o console para mais detalhes.");
                }
            });

            // fechar modal clicando fora
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal(modal.id);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>

</body>
</html>
